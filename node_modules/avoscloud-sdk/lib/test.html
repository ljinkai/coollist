<html>
  <head>
    <script src="av.js"></script>
    <script>
      AV.initialize("8y5ria0dtbvz7qp6alzy00p9nggky304fafdusfo79fba5sk", "nfkx5k3p7otysvhr2fp84mxl8ggmehu7swyi18auvmrg7kd4");
      function fun(count) {
        var now = new Date();
        var Project = AV.Object.extend("project");
        var query = new AV.Query(Project);
        query.equalTo('state', 'prestart');
        query.lessThanOrEqualTo("startDate", now);
        query.find({
          success: function (results) {
            if (count > 0) {
              fun(count - 1);
            }
            for (var i = 0; i < results.length; i++) {
              var object = results[i];
              console.log("find prestart project %s to start", object.get('name'));
              object.set('state', 'started');
              object.save();
            }
            },
            error: function (error) {
              console.log("projectstate_timer query Error: " + error.code + " " + error.message);
            }
        });

        query = new AV.Query(Project);
        query.equalTo('state', 'started');
        query.lessThanOrEqualTo("closeDate", now);
        query.find({
          success: function (results) {
            for (var i = 0; i < results.length; i++) {
              var object = results[i];
              console.log("find prestart project %s to close", object.get('name'));
              object.set('state', 'closed');
              object.save();
            }
          },
          error: function (error) {
              console.log("projectstate_timer query Error: " + error.code + " " + error.message);
          }
        });
      }

      function t() {
        for (i = 0; i < 10; i++) {
         fun(1000)
       }
      }

      function t2() {
        var now = new Date();
        var Project = AV.Object.extend("project");
        var query = new AV.Query(Project);
//        query.equalTo('state', 'prestart');
//        query.lessThanOrEqualTo("startDate", now);
        query.find({
          success: function (results) {
            for (var i = 0; i < results.length; i++) {
              var object = results[i];
              console.log("find prestart project %s to start", object.get('name'));
              object.set('state', 'started');
              object.save();
            }
          },
          error: function (error) {
            console.log("projectstate_timer query Error: " + error.code + " " + error.message);
            res.error("project state query failed," + error.message);
          }
        });
      }

    </script>
    </head>
    <body>
      <input type="button" onClick="t()">
      <input type="button" onClick="t2()">

    </body>
  </html>
